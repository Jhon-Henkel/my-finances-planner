name: Main Branch Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  back-end-tests:
    name: ðŸ”¨Testing Back-end code

    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”¨Configuring PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: ðŸ”¥Configuring checkout V3
      uses: actions/checkout@v3

    - name: ðŸ“„Making .env file
      run: |
        echo "${{ secrets.ENV_MFP_PERSONAL }}" > .env

    - name: ðŸ“½Installing dependencies
      run: composer install

    - name: ðŸ‘Applying permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: ðŸ”¨Executing PHP Unit tests
      run: composer run test:unit

    - name: ðŸ·Making coverage badge
      uses: timkrase/phpunit-coverage-badge@v1.2.1
      with:
        coverage_badge_path: output/coverage.svg
        push_badge: false

    - name: âž•Uploading coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./clover.xml

  private-deploy:
    name: ðŸš€Deploy build to private server

    runs-on: ubuntu-latest
    needs: [ back-end-tests ]

    steps:
      - name: ðŸ”¥Configuring checkout V3
        uses: actions/checkout@v3

      - name: ðŸ”¥Configuring Node
        uses: actions/setup-node@v3
        with:
          node-version: 'latest'

      - name: ðŸ”¨Installing Node dependencies
        run: npm install

      - name: ðŸ“„Making .env
        run: |
          echo "${{ secrets.ENV_MFP_PERSONAL }}" > .env

      - name: ðŸ”¨Building application
        run: npm run build

      - name: ðŸ“‚Upload files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_ADDRESS }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./public/build/
          server-dir: ./my-finances-planner/public/build/
          dangerous-clean-slate: true